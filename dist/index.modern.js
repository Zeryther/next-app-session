import{nanoid as t}from"nanoid";import e from"cookie-signature";import{cookies as s}from"next/headers";import{RequestCookies as i}from"next/dist/compiled/@edge-runtime/cookies";import{promisify as o}from"util";function n(){return n=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var s=arguments[e];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(t[i]=s[i])}return t},n.apply(this,arguments)}class r{constructor(){return this.store=void 0,global.sessionMemoryStore?global.sessionMemoryStore:(this.store=new Map,global.sessionMemoryStore=this,this)}async get(t){const e=this.store.get(t);if(e){var s;const i=JSON.parse(e,(t,e)=>"expires"===t?new Date(e):e);return null!=(s=i.cookie)&&s.expires&&i.cookie.expires.getTime()<=Date.now()?(await this.destroy(t),null):i}return null}async set(t,e){this.store.set(t,JSON.stringify(e))}async destroy(t){this.store.delete(t)}async touch(t,e){this.store.set(t,JSON.stringify(e))}}function l(t){const e=t.store||new r;return s=>new a(e,t,s)}class a{constructor(e,s,i){return this.req=void 0,this.store=void 0,this.sid=void 0,this.name=void 0,this.secret=void 0,this.genid=void 0,this.cookieOpts=void 0,this.touchAfter=void 0,this.req=i,this.store=e,this.name=(null==s?void 0:s.name)||"sid",this.secret=null==s?void 0:s.secret,this.genid=(null==s?void 0:s.genid)||t,this.cookieOpts=null==s?void 0:s.cookie,this.touchAfter=null==s?void 0:s.touchAfter,this}getCookie(t){var e,i;return null!=(e=this.req)&&e.cookies?this.req.cookies[t]:null==(i=s().get(t))?void 0:i.value}setCookie(t,e,o){var n;if(null!=(n=this.req)&&n.headers){const s=new Headers(this.req.headers);new i(s).set(t,e)}return s().set(t,e,o)}_getID(){return this.decode(this.getCookie(this.name))}_initID(){let t=this._getID();console.log("id",t),!t&&this.genid&&(t=this.genid()),this.sid=t||""}encode(t){return this.secret&&""!=this.secret?t?"s:"+e.sign(t,this.secret||""):"":t}decode(t){return t&&this.secret&&""!=this.secret?e.unsign(t.slice(2),this.secret||"")||null:t||null}async all(){var t;this._initID();const e=await(null==(t=this.store)?void 0:t.get(this.sid));return console.log("data",e),null!=e?e:{}}async get(t){var e;const s=await this.all();return null!=(e=null==s?void 0:s[t])?e:null}async has(t){const e=await this.all();return!(null==e||!e[t])&&""!==(null==e?void 0:e[t])}async set(t,e){let s=await this.all();s||(s={}),s[t]=e,await this.setAll(s)}async setAll(t){this._initID();const e=this._getID();var s,i,o,r,l,a;e&&""!=e||await this.setCookie(this.name,this.encode(this.sid),{path:(null==(s=this.cookieOpts)?void 0:s.path)||"/",httpOnly:null==(i=null==(o=this.cookieOpts)?void 0:o.httpOnly)||i,domain:(null==(r=this.cookieOpts)?void 0:r.domain)||void 0,sameSite:null==(l=this.cookieOpts)?void 0:l.sameSite,secure:(null==(a=this.cookieOpts)?void 0:a.secure)||!1}),await this.store.set(this.sid,n({},t))}async destroy(t){if(t){const e=await this.all()||{};delete e[t],await this.setAll(e)}else await this.setAll({})}}function h(t){return n({get:o(t.get).bind(t),set:o(t.set).bind(t),destroy:o(t.destroy).bind(t)},t.touch&&{touch:o(t.touch).bind(t)})}a.instance=void 0;export{a as AppSession,r as MemoryStore,l as default,h as promisifyStore};
//# sourceMappingURL=index.modern.js.map
